"use client";
import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { createClient } from "../../lib/supabase/client";

export default function Budget() {
    const router = useRouter();
    const [user, setUser] = useState(null);
    const [totalBudget, setTotalBudget] = useState(30000);
    const [expenses, setExpenses] = useState([]);
    const [loading, setLoading] = useState(true);
    const [isAdding, setIsAdding] = useState(false);
    const [newExpense, setNewExpense] = useState({ category: "Other", item: "", cost: "", notes: "" });
    const [showSuggestions, setShowSuggestions] = useState(false);
    const [saving, setSaving] = useState(false);
    const [showSuccess, setShowSuccess] = useState(false);
    const [editingId, setEditingId] = useState(null);
    const [editForm, setEditForm] = useState({ category: "", item: "", cost: "", notes: "" });

    // Common wedding expense suggestions
    const itemSuggestions = [
        "Venue Rental", "Catering Service", "Wedding Dress", "Groom's Suit", "Photographer", "Videographer",
        "Wedding Cake", "Flowers & Bouquets", "DJ/Band", "Invitations", "Decorations", "Wedding Rings",
        "Hair & Makeup", "Transportation", "Hotel Accommodation", "Rehearsal Dinner", "Wedding Favors",
        "Ceremony Music", "Reception Music", "Lighting", "Table Linens", "Chairs", "Dance Floor"
    ];

    // Filter suggestions based on input
    const filteredSuggestions = newExpense.item
        ? itemSuggestions.filter(s => s.toLowerCase().includes(newExpense.item.toLowerCase()))
        : itemSuggestions;

    const totalSpent = expenses.reduce((acc, curr) => acc + (curr.paid ? curr.cost : 0), 0);
    const remaining = totalBudget - totalSpent;
    const percentSpent = Math.round((totalSpent / totalBudget) * 100);

    useEffect(() => {
        const supabase = createClient();

        const fetchData = async () => {
            // Get user
            const { data: { user } } = await supabase.auth.getUser();
            setUser(user);

            if (user) {
                // Fetch wedding data for total budget
                const { data: wedding } = await supabase
                    .from('weddings')
                    .select('total_budget')
                    .eq('user_id', user.id)
                    .single();

                if (wedding?.total_budget) {
                    setTotalBudget(wedding.total_budget);
                }

                // Fetch budget items
                const { data: items } = await supabase
                    .from('budget_items')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });

                setExpenses(items || []);
            }

            setLoading(false);
        };

        fetchData();
    }, []);

    const handleAddExpense = async (e) => {
        e.preventDefault();
        if (!newExpense.item || !newExpense.cost || !user) return;

        setSaving(true);
        const supabase = createClient();

        const { data, error } = await supabase
            .from('budget_items')
            .insert({
                user_id: user.id,
                category: newExpense.category,
                item: newExpense.item,
                cost: parseFloat(newExpense.cost),
                notes: newExpense.notes || null,
                paid: false
            })
            .select()
            .single();

        if (!error && data) {
            setExpenses([data, ...expenses]);
            setNewExpense({ category: "Other", item: "", cost: "", notes: "" });
            setIsAdding(false);
            setShowSuccess(true);
            setTimeout(() => setShowSuccess(false), 3000);
        }
        setSaving(false);
    };

    const togglePaid = async (id, currentPaid) => {
        const supabase = createClient();

        const { error } = await supabase
            .from('budget_items')
            .update({ paid: !currentPaid, updated_at: new Date().toISOString() })
            .eq('id', id);

        if (!error) {
            setExpenses(expenses.map(exp =>
                exp.id === id ? { ...exp, paid: !currentPaid } : exp
            ));
        }
    };

    const deleteExpense = async (id) => {
        const supabase = createClient();

        // Optimistically update UI first
        const updatedExpenses = expenses.filter(exp => exp.id !== id);
        setExpenses(updatedExpenses);

        // Then delete from database
        const { error } = await supabase
            .from('budget_items')
            .delete()
            .eq('id', id);

        // If error, revert the change
        if (error) {
            setExpenses(expenses);
        }
    };

    const startEdit = (expense) => {
        setEditingId(expense.id);
        setEditForm({
            category: expense.category,
            item: expense.item,
            cost: expense.cost,
            notes: expense.notes || ""
        });
    };

    const cancelEdit = () => {
        setEditingId(null);
        setEditForm({ category: "", item: "", cost: "", notes: "" });
    };

    const saveEdit = async (id) => {
        setSaving(true);
        const supabase = createClient();

        const { error } = await supabase
            .from('budget_items')
            .update({
                category: editForm.category,
                item: editForm.item,
                cost: parseFloat(editForm.cost),
                notes: editForm.notes || null,
                updated_at: new Date().toISOString()
            })
            .eq('id', id);

        if (!error) {
            setExpenses(expenses.map(exp =>
                exp.id === id ? { ...exp, ...editForm, cost: parseFloat(editForm.cost) } : exp
            ));
            setEditingId(null);
            setShowSuccess(true);
            setTimeout(() => setShowSuccess(false), 3000);
        }
        setSaving(false);
    };

    if (loading) {
        return (
            <div className="min-h-screen flex items-center justify-center">
                <span className="loading loading-spinner loading-lg text-primary"></span>
            </div>
        );
    }

    return (
        <>
            {showSuccess && (
                <div className="toast toast-top toast-end z-50">
                    <div className="alert alert-success">
                        <svg xmlns="http://www.w3.org/2000/svg" className="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Expense saved successfully!</span>
                    </div>
                </div>
            )}
            <div className="min-h-screen bg-gradient-to-br from-base-100 via-base-100 to-primary/5">
                <div className="max-w-5xl mx-auto px-4 py-8">
                    <header className="flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-8 pb-6 border-b border-base-300">
                        <div className="flex items-center gap-4">
                            <Link href="/dashboard" className="btn btn-circle btn-ghost hover:bg-base-200">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </Link>
                            <div>
                                <h1 className="text-3xl font-bold text-primary mb-1">Budget Planner</h1>
                                <p className="text-base-content/60">Manage your wedding expenses</p>
                            </div>
                        </div>

                        <div className="bg-base-100 p-6 rounded-xl shadow-sm border border-base-200 flex items-center gap-6">
                            <div className="flex flex-col gap-1">
                                <span className="text-xs uppercase tracking-wider text-base-content/60 font-semibold">Total Budget</span>
                                <span className="text-xl font-bold text-base-content">${totalBudget.toLocaleString()}</span>
                            </div>
                            <div className="w-px h-10 bg-base-200"></div>
                            <div className="flex flex-col gap-1">
                                <span className="text-xs uppercase tracking-wider text-base-content/60 font-semibold">Spent</span>
                                <span className="text-xl font-bold text-warning">
                                    ${totalSpent.toLocaleString()}
                                </span>
                            </div>
                            <div className="w-px h-10 bg-base-200"></div>
                            <div className="flex flex-col gap-1">
                                <span className="text-xs uppercase tracking-wider text-base-content/60 font-semibold">Remaining</span>
                                <span className="text-xl font-bold text-success">
                                    ${remaining.toLocaleString()}
                                </span>
                            </div>
                        </div>
                    </header>

                    <div className="mb-8 flex items-center gap-4">
                        <div className="flex-1 h-3 bg-base-200 rounded-full overflow-hidden">
                            <div
                                className="h-full rounded-full transition-all duration-500 ease-out"
                                style={{ width: `${Math.min(percentSpent, 100)}%`, background: percentSpent > 100 ? 'var(--error)' : 'var(--primary)' }}
                            ></div>
                        </div>
                        <span className="text-sm font-semibold text-base-content/60 min-w-[80px] text-right">{percentSpent}% Spent</span>
                    </div>

                    <div className="mb-6">
                        <button className="btn btn-primary" onClick={() => setIsAdding(!isAdding)}>
                            {isAdding ? "Cancel" : "+ Add Expense"}
                        </button>
                    </div>

                    {isAdding && (
                        <form onSubmit={handleAddExpense} className="bg-base-100 p-6 rounded-lg border border-base-200 mb-6 animate-[slideDown_0.3s_ease-out]">
                            <div className="flex flex-col md:flex-row gap-4 items-stretch md:items-center mb-4">
                                <div className="flex-1 relative">
                                    <input
                                        type="text"
                                        placeholder="Item Name"
                                        value={newExpense.item}
                                        onChange={(e) => setNewExpense({ ...newExpense, item: e.target.value })}
                                        onFocus={() => setShowSuggestions(true)}
                                        onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
                                        className="input input-bordered w-full"
                                        autoFocus
                                    />
                                    {showSuggestions && filteredSuggestions.length > 0 && (
                                        <div className="absolute z-10 w-full mt-1 bg-base-100 border border-base-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                            {filteredSuggestions.map((suggestion, index) => (
                                                <div
                                                    key={index}
                                                    className="px-4 py-2 hover:bg-base-200 cursor-pointer text-sm"
                                                    onClick={() => {
                                                        setNewExpense({ ...newExpense, item: suggestion });
                                                        setShowSuggestions(false);
                                                    }}
                                                >
                                                    {suggestion}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div className="flex-1">
                                    <select
                                        value={newExpense.category}
                                        onChange={(e) => setNewExpense({ ...newExpense, category: e.target.value })}
                                        className="select select-bordered w-full"
                                    >
                                        <option>Venue</option>
                                        <option>Catering</option>
                                        <option>Attire</option>
                                        <option>Photography</option>
                                        <option>Music</option>
                                        <option>Decor</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div className="flex-1">
                                    <input
                                        type="number"
                                        placeholder="Cost"
                                        value={newExpense.cost}
                                        onChange={(e) => setNewExpense({ ...newExpense, cost: e.target.value })}
                                        className="input input-bordered w-full"
                                    />
                                </div>
                                <button type="submit" className="btn btn-primary" disabled={saving}>
                                    {saving ? "Saving..." : "Save"}
                                </button>
                            </div>
                            <div className="w-full">
                                <textarea
                                    placeholder="Notes (optional)"
                                    value={newExpense.notes}
                                    onChange={(e) => setNewExpense({ ...newExpense, notes: e.target.value })}
                                    className="textarea textarea-bordered w-full"
                                    rows="2"
                                />
                            </div>
                        </form>
                    )}



                    <div className="flex flex-col gap-2">
                        {expenses.length === 0 ? (
                            <div className="bg-base-100 border border-base-200 rounded-lg p-12 text-center">
                                <div className="max-w-md mx-auto">
                                    <div className="text-6xl mb-4">ðŸ’°</div>
                                    <h3 className="text-xl font-semibold text-base-content mb-2">No expenses yet</h3>
                                    <p className="text-base-content/60 mb-6">Start tracking your wedding budget by adding your first expense item.</p>
                                    <button className="btn btn-primary" onClick={() => setIsAdding(true)}>
                                        + Add Your First Expense
                                    </button>
                                </div>
                            </div>
                        ) : (
                            expenses.map((expense) => (
                                <div key={expense.id} className="bg-base-100 px-6 py-4 rounded-sm border border-base-200 flex justify-between items-start transition-all duration-150 hover:border-primary/30 hover:shadow-sm">
                                    <div className="flex items-start gap-4 flex-1">
                                        <span className="text-xs bg-base-200 px-3 py-1 rounded-full text-base-content/60 font-medium uppercase mt-0.5">{expense.category}</span>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2">
                                                <span className="font-medium text-base-content">{expense.item}</span>
                                                {expense.notes && (
                                                    <div className="dropdown dropdown-hover">
                                                        <div tabIndex={0} role="button" className="btn btn-circle btn-ghost btn-xs text-base-content/40 hover:text-base-content">
                                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                            </svg>
                                                        </div>
                                                        <div tabIndex={0} className="dropdown-content z-10 card card-compact w-64 p-4 shadow-lg bg-base-100 border border-base-200 rounded-lg">
                                                            <p className="text-sm text-base-content/80">{expense.notes}</p>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-6">
                                        <span className="font-semibold text-base-content">${expense.cost.toLocaleString()}</span>
                                        <button
                                            className={`px-3 py-1 rounded-full text-xs font-semibold border ${expense.paid ? 'bg-success/10 text-success border-success/20' : 'bg-base-200 text-base-content/60 border-base-300'}`}
                                            onClick={() => togglePaid(expense.id, expense.paid)}
                                        >
                                            {expense.paid ? "Paid" : "Unpaid"}
                                        </button>
                                        <button
                                            className="text-base-content/40 text-2xl leading-none px-1 hover:text-error"
                                            onClick={() => deleteExpense(expense.id)}
                                            aria-label="Delete expense"
                                        >
                                            Ã—
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            </div>
        </>
    );
}
